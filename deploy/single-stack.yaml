version: "3.9"

services:
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    environment:
      SERVICES: 1
      TASKS: 1
      INFO: 1
      PING: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - sentinel-internal
    deploy:
      placement:
        constraints: [node.role == manager]
      resources:
        limits:
          memory: 64M

  sentinel:
    image: swarm-sentinel:latest
    environment:
      SS_COMPOSE_URL: https://artifacts.example.com/prod/compose.yml
      SS_STACK_NAME: prod
      SS_DOCKER_PROXY_URL: http://docker-socket-proxy:2375
      SS_POLL_INTERVAL: 30s
      SS_LOG_LEVEL: info
      SS_HEALTH_PORT: 8080
      SS_METRICS_PORT: 9090
      SS_SLACK_WEBHOOK_URL_FILE: /run/secrets/slack-webhook
    secrets:
      - slack-webhook
    volumes:
      - sentinel-state:/var/lib/swarm-sentinel
    networks:
      - sentinel-internal
    depends_on:
      - docker-socket-proxy
    deploy:
      placement:
        constraints: [node.role == manager]
      replicas: 1
      resources:
        limits:
          memory: 128M
      healthcheck:
        test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
        interval: 30s
        timeout: 5s
        retries: 3

networks:
  sentinel-internal:
    driver: overlay

volumes:
  sentinel-state:

secrets:
  slack-webhook:
    external: true
